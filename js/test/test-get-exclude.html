<?xml version = "1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"DTD/xhtml1-strict.dtd">
<!-- 
	See COPYING for copyright and distribution information.
-->
<html xmlns = "http://www.w3.org/1999/xhtml">
<meta charset="UTF-8">

<head>
	<title>NDN Fetch Content Object using Exclude</title>
	
	<script type="text/javascript" src="../tools/build/ndn-js.js"></script>

	<script type="text/javascript">
		var ndn = new NDN({port:9696,host:"localhost"});
        ndn.transport.connectWebSocket(ndn);
        
        ndn.onopen = function() {
        	document.getElementById("testBtn").disabled = false;
        };
        
        var AsyncGetClosure = function AsyncGetClosure() {
        	// Inherit from Closure.
			Closure.call(this);
		};
		
		AsyncGetClosure.prototype.upcall = function(kind, upcallInfo) {
			//console.log("Closure.upcall() executed.");
			if (kind == Closure.UPCALL_FINAL) {
				// Do nothing.
			} else if (kind == Closure.UPCALL_CONTENT) {
				//console.log("Closure.upcall: content signature verification pass.");
				var content = upcallInfo.contentObject;
				//console.log(content.name);
				nameStr = content.name.getName();
				var l = content.name.components.length;
				console.log(content.name.components[l-1]);
				document.getElementById('content').innerHTML = "<p>Name string: " + nameStr + "</p>";
				document.getElementById('content').innerHTML += "<p>Content buffer length: " + content.content.length + "</p>";
				//console.log("In callback, nameStr: " + nameStr);
				//console.log("In callback, content: ");
				//console.log(content);
				document.getElementById('content').innerHTML += contentObjectToHtml(content);
			} else if (kind == Closure.UPCALL_CONTENT_BAD) {
				var content = upcallInfo.contentObject;
				console.log("Closure.upcall: content signature verification fail.");
				if (content.signature.signature)
					console.log("Signature: " + DataUtils.toHex(content.signature.signature).toLowerCase());
				if (content.signature.Witness)
					console.log("Witness: " + DataUtils.toHex(content.signature.Witness).toLowerCase());
			} else if (kind == Closure.UPCALL_INTEREST_TIMED_OUT) {
				console.log("Closure.upcall called with interest time out.");
			}
			return Closure.RESULT_OK;
		};
		
		function run() {
			var seek = document.getElementById('exclude').value;
			//console.log(seek);
			//console.log(UnsignedIntToArrayBuffer(seek));
			var filter = new Exclude([Exclude.ANY, UnsignedIntToArrayBuffer(seek)]);
			
			var template = new Interest();
			template.childSelector = 0;
            template.interestLifetime = 1000;
            template.exclude = filter;
			ndn.expressInterest(new Name(document.getElementById('interest').value), new AsyncGetClosure(), template);
		}
		
		function UnsignedIntToArrayBuffer(value) {
		    if (value <= 0)
		        return new Uint8Array([0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]);
		    
		    // Encode into 64 bits.
		    var size = 8;
		    var result = new Uint8Array(size);
		    var i = 0;
		    while (i < 8) {
		    	//console.log(value);
		        ++i;
		        result[size - i] = value % 256;
		        value = Math.floor(value / 256);
		    }
		    return result;
		};
	</script>
	
</head>
<body >

	<form>
		Please Enter an Interest:<br />
		<input id="interest" type="text" name="INTEREST" size="50" value="/wentao.shang/logtest/%FD%05%13%E5%C8%C8%D0/index" /><br />
		Exclude:<br /><input id="exclude" type="text" name="Exclude" size="20" value="1363039109923" /> 
	</form>

	<button id="testBtn" onclick="run()" disabled="disabled">Fetch Content</button>
	
	<p id="content"><br/></p>

</body>
</html>
