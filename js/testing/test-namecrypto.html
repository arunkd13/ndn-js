<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>NameCrypto for NDN.JS</title>
	
	<script type="text/javascript" src="../tools/build/ndn-js.js"></script>
	<script type="text/javascript" src="../security/NameCrypto.js"></script>

	<script type="text/javascript">
	
		function testNameCrypto() {
			var result = document.getElementById('result');
			
			var publicKeyBytes = DataUtils.toNumbers(globalKeyManager.publicKey);
			var locator = new KeyLocator(publicKeyBytes, KeyLocatorType.KEY);
			var enc = new BinaryXMLEncoder();
			locator.to_ccnb(enc);
			var n_loc = enc.getReducedOstream();
			//console.log(n_loc);
			
			//result.innerHTML += DataUtils.toHex(enc.getReducedOstream()) + '<br />';
			
			var name = new Name("/ndn/ucla.edu/apps/cuerda");
			name.add(n_loc);
			var name1 = new Name("/ndn/ucla.edu/apps/cuerda");
			
			var app_code = "cuerda";
			
			var rsa = new RSAKey();
			
			rsa.readPrivateKeyFromPEMString(globalKeyManager.privateKey);
			
			var state = new NameCryptoState();
			
			var ret = NameCrypto.authenticate_name_asymm(state, name, app_code, rsa);
			
			result.innerHTML += '<p>' + ret.getName() + '</p>';
			
			var ret1 = NameCrypto.verify_name_asymm(ret);
			
			result.innerHTML += '<p>' + ret1 + '</p>';
			
			var secret = '1234567812345678';
			var timeout = 3000;  // in ms
			
			var app_key = NameCrypto.generate_symmetric_key(secret, app_code);
			
			var ret2 = NameCrypto.authenticate_name_symm(state, name1, app_code, app_key);
			
			result.innerHTML += '<p>' + ret2.getName() + '</p>';
			
			var ret3 = NameCrypto.verify_name_symm(ret2, secret, timeout, app_code);
			
			result.innerHTML += '<p>' + ret3 + '</p>';
		}
		
		var AsyncGetClosure = function AsyncGetClosure() {
        	// Inherit from Closure.
			Closure.call(this);
		};
		
		AsyncGetClosure.prototype.upcall = function(kind, upcallInfo) {
			//console.log("Closure.upcall() executed.");
			if (kind == Closure.UPCALL_FINAL) {
				// Do nothing.
			} else if (kind == Closure.UPCALL_CONTENT) {
				//console.log("Closure.upcall: content signature verification pass.");
				var content = upcallInfo.contentObject;
				//console.log(content.name);
				nameStr = content.name.getName();
				document.getElementById('content').innerHTML = "<p>Name string: " + nameStr + "</p>";
				document.getElementById('content').innerHTML += "<p>Content buffer length: " + content.content.length + "</p>";
				//console.log("In callback, nameStr: " + nameStr);
				//console.log("In callback, content: ");
				//console.log(content);
				document.getElementById('content').innerHTML += contentObjectToHtml(content);
			} else if (kind == Closure.UPCALL_CONTENT_BAD) {
				var content = upcallInfo.contentObject;
				console.log("Closure.upcall: content signature verification fail.");
				if (content.signature.signature)
					console.log("Signature: " + DataUtils.toHex(content.signature.signature).toLowerCase());
				if (content.signature.Witness)
					console.log("Witness: " + DataUtils.toHex(content.signature.Witness).toLowerCase());
			} else if (kind == Closure.UPCALL_INTEREST_TIMED_OUT) {
				console.log("Closure.upcall called with interest time out.");
			}
			return Closure.RESULT_OK;
		};
		
		function run() {
			var template = new Interest();
			template.childSelector = 1;
			template.answerOriginKind = 0;
			template.interestLifetime = 1000;
			
			var name = new Name("/local/discovery/sensor");
			
			var secret = '1234567812345678';
			var app_code = 'cuerda';
			var shared_key = NameCrypto.generate_symmetric_key(secret, app_code);
			
			var state = new NameCryptoState();
			var auth = NameCrypto.authenticate_name_symm(state, name, app_code, shared_key);
			
			var closure = new AsyncGetClosure();

			ndn.expressInterest(auth, closure, template);
		}
		
		var ndn;
		function testConfig() {
			ndn = new NDN({port:9696, host:'localhost', onopen:run});
			ndn.transport.connectWebSocket(ndn);
		}
		
	</script>

</head>
<body >
	<button onclick="testNameCrypto()">Test</button>
	
	<button onclick="testConfig()">Test2</button>
	
	<div id="result">
		
	</div>

</body>
</html>
